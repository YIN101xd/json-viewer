<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Viewer - Â§öÊ†ºÂºèÊîØÊåÅ</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f5f7fa;
            height: 100vh;
            overflow: hidden;
            color: #2c3e50;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left h1 {
            font-size: 1.5em;
            margin-bottom: 3px;
        }

        .header-left .subtitle {
            font-size: 0.85em;
            opacity: 0.9;
        }

        .format-selector {
            display: flex;
            gap: 10px;
            background: rgba(255,255,255,0.2);
            padding: 8px;
            border-radius: 8px;
        }

        .format-btn {
            padding: 8px 20px;
            border: 2px solid rgba(255,255,255,0.5);
            background: transparent;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
            font-weight: 500;
        }

        .format-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .format-btn.active {
            background: white;
            color: #667eea;
            border-color: white;
        }

        .main-container {
            display: flex;
            height: calc(100vh - 75px);
        }

        .left-panel {
            width: 280px;
            background: white;
            border-right: 1px solid #e1e8ed;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .upload-section {
            padding: 15px;
            border-bottom: 1px solid #e1e8ed;
        }

        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 20px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9ff;
        }

        .upload-area:hover {
            background: #eef2ff;
            border-color: #764ba2;
        }

        .upload-icon {
            font-size: 2em;
            margin-bottom: 8px;
        }

        .upload-text {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 10px;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            margin: 2px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #e1e8ed;
            color: #666;
        }

        .file-list-section {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .file-item {
            padding: 10px 12px;
            margin-bottom: 6px;
            background: #f8f9fa;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .file-item:hover {
            background: #eef2ff;
            border-left-color: #667eea;
            transform: translateX(2px);
        }

        .file-item.active {
            background: #eef2ff;
            border-left-color: #667eea;
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.2);
        }

        .file-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.85em;
            margin-bottom: 4px;
        }

        .file-meta {
            font-size: 0.7em;
            color: #95a5a6;
        }

        .file-tags {
            margin-top: 5px;
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .file-tag {
            background: #667eea;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.65em;
        }

        .right-panel {
            flex: 1;
            background: #fafbfc;
            overflow-y: auto;
            padding: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 100px 20px;
            color: #95a5a6;
        }

        .detail-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .detail-header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            margin-bottom: 15px;
        }

        .detail-title {
            font-size: 1.5em;
            color: #2c3e50;
            margin-bottom: 12px;
        }

        .metadata-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .meta-tag {
            background: #eef2ff;
            color: #667eea;
            padding: 4px 10px;
            border-radius: 5px;
            font-size: 0.8em;
        }

        .meta-tag.difficulty-easy {
            background: #d4edda;
            color: #155724;
        }

        .meta-tag.difficulty-medium {
            background: #fff3cd;
            color: #856404;
        }

        .meta-tag.difficulty-hard {
            background: #f8d7da;
            color: #721c24;
        }

        .content-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            margin-bottom: 15px;
        }

        .section-title {
            font-size: 1.2em;
            color: #2c3e50;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #667eea;
        }

        .markdown-content {
            line-height: 1.7;
            color: #34495e;
            font-size: 0.95em;
        }

        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 12px 0;
        }

        .markdown-content table th,
        .markdown-content table td {
            border: 1px solid #e1e8ed;
            padding: 8px;
            text-align: left;
        }

        .markdown-content table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .model-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .model-tab {
            padding: 8px 16px;
            border: 2px solid #e1e8ed;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85em;
            background: white;
        }

        .model-tab:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .model-tab.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .model-response {
            display: none;
        }

        .model-response.active {
            display: block;
        }

        .scoring-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            margin-bottom: 15px;
        }

        .rubrics-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            font-size: 0.85em;
        }

        .rubrics-table thead {
            background: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .rubrics-table th {
            padding: 10px 8px;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 2px solid #e1e8ed;
        }

        .rubrics-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #f0f0f0;
        }

        .rubrics-table tbody tr {
            transition: all 0.2s;
        }

        .rubrics-table tbody tr:hover {
            background: #f8f9ff;
            cursor: pointer;
        }

        .rubric-label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 2px;
        }

        .rubric-category {
            font-size: 0.8em;
            color: #95a5a6;
        }

        .score-cell {
            text-align: center;
            min-width: 60px;
        }

        .score-value {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .score-1 {
            background: #d4edda;
            color: #155724;
        }

        .score-0 {
            background: #f8d7da;
            color: #721c24;
        }

        .score-other {
            background: #e2e3e5;
            color: #383d41;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            max-width: 900px;
            max-height: 85vh;
            overflow-y: auto;
            padding: 25px;
            position: relative;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-close {
            position: absolute;
            top: 12px;
            right: 12px;
            font-size: 1.5em;
            cursor: pointer;
            color: #95a5a6;
            background: none;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #f0f0f0;
            color: #2c3e50;
        }

        .modal-title {
            font-size: 1.3em;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-right: 30px;
        }

        .modal-section {
            margin-bottom: 20px;
        }

        .modal-section-title {
            font-size: 1em;
            color: #667eea;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .modal-section-content {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            line-height: 1.6;
            font-size: 0.9em;
        }

        .judgement-box {
            background: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 4px solid #667eea;
        }

        input[type="file"] {
            display: none;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

        .total-scores {
            margin: 20px 0;
        }

        .score-cards {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .score-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 12px;
            text-align: center;
            min-width: 120px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .score-card-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .score-card-value {
            font-size: 2em;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <h1>üìä JSON Viewer - Â§öÊ†ºÂºèÊîØÊåÅ</h1>
            <p class="subtitle">ÊîØÊåÅÊåá‰ª§Ê†ºÂºè & Deep Research Ê†ºÂºè</p>
        </div>
        <div class="format-selector">
            <button class="format-btn active" id="formatKimi" onclick="switchFormat('kimi')">Êåá‰ª§Ê†ºÂºè</button>
            <button class="format-btn" id="formatDR" onclick="switchFormat('dr')">DR Ê†ºÂºè</button>
        </div>
    </div>

    <div class="main-container">
        <div class="left-panel">
            <div class="upload-section">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">üìÅ</div>
                    <div class="upload-text">ÊãñÊãΩÊñá‰ª∂ÊàñÊñá‰ª∂Â§π</div>
                    <div>
                        <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">ÈÄâÊã©Êñá‰ª∂</button>
                        <button class="btn btn-primary" onclick="document.getElementById('folderInput').click()">ÈÄâÊã©Êñá‰ª∂Â§π</button>
                    </div>
                    <div style="margin-top: 8px;">
                        <button class="btn btn-secondary" onclick="clearData()">Ê∏ÖÈô§</button>
                    </div>
                </div>
                <input type="file" id="fileInput" accept=".json" multiple onchange="handleFiles(this.files)">
                <input type="file" id="folderInput" webkitdirectory directory multiple onchange="handleFiles(this.files)">
            </div>

            <div class="file-list-section" id="fileListSection">
                <div id="fileList"></div>
            </div>
        </div>

        <div class="right-panel" id="rightPanel">
            <div class="empty-state">
                <div style="font-size: 3em; margin-bottom: 15px;">üìã</div>
                <h3>ËØ∑‰∏ä‰º† JSON Êñá‰ª∂</h3>
                <p style="margin-top: 8px;">ÊîØÊåÅÊåá‰ª§Ê†ºÂºèÂíå Deep Research Ê†ºÂºè</p>
                <p style="margin-top: 5px; font-size: 0.9em;">ÂÖàÈÄâÊã©Ê†ºÂºèÔºåÂÜç‰∏ä‰º†ÂØπÂ∫îÁöÑÊï∞ÊçÆÊñá‰ª∂</p>
            </div>
        </div>
    </div>

    <div class="modal" id="rubricModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">√ó</button>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        let jsonData = {};
        let currentFile = null;
        let currentModelTab = null;
        let currentFormat = 'kimi'; // 'kimi' or 'dr'

        if (typeof marked !== 'undefined') {
            marked.setOptions({
                breaks: true,
                gfm: true
            });
        }

        function switchFormat(format) {
            currentFormat = format;
            document.getElementById('formatKimi').classList.toggle('active', format === 'kimi');
            document.getElementById('formatDR').classList.toggle('active', format === 'dr');

            // Ê∏ÖÈô§ÂΩìÂâçÊï∞ÊçÆÔºåÊèêÁ§∫ÈáçÊñ∞‰∏ä‰º†
            if (Object.keys(jsonData).length > 0) {
                if (confirm('ÂàáÊç¢Ê†ºÂºèÂ∞ÜÊ∏ÖÈô§ÂΩìÂâçÊï∞ÊçÆÔºåÊòØÂê¶ÁªßÁª≠Ôºü')) {
                    clearData();
                } else {
                    // ÊÅ¢Â§ç‰πãÂâçÁöÑÊ†ºÂºèÈÄâÊã©
                    currentFormat = format === 'kimi' ? 'dr' : 'kimi';
                    switchFormat(currentFormat);
                }
            }
        }

        const uploadArea = document.getElementById('uploadArea');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.background = '#eef2ff';
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.background = '#f8f9ff';
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.background = '#f8f9ff';

            const items = e.dataTransfer.items;
            const files = [];
            const promises = [];

            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                if (item.kind === 'file') {
                    const entry = item.webkitGetAsEntry();
                    if (entry) {
                        promises.push(traverseFileTree(entry, files));
                    }
                }
            }

            Promise.all(promises).then(() => handleFiles(files));
        });

        function traverseFileTree(entry, files) {
            return new Promise((resolve) => {
                if (entry.isFile) {
                    entry.file((file) => {
                        if (file.name.endsWith('.json')) {
                            files.push(file);
                        }
                        resolve();
                    });
                } else if (entry.isDirectory) {
                    const dirReader = entry.createReader();
                    dirReader.readEntries((entries) => {
                        const promises = entries.map(e => traverseFileTree(e, files));
                        Promise.all(promises).then(resolve);
                    });
                }
            });
        }

        function handleFiles(files) {
            jsonData = {};
            currentFile = null;

            let loadedCount = 0;
            const fileArray = Array.from(files).filter(f => f.name.endsWith('.json'));

            if (fileArray.length === 0) {
                alert('Êú™ÊâæÂà∞JSONÊñá‰ª∂');
                return;
            }

            fileArray.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        jsonData[file.name] = {
                            data: data,
                            size: file.size,
                            modified: file.lastModified
                        };

                        loadedCount++;
                        if (loadedCount === fileArray.length) {
                            displayFileList();
                            if (Object.keys(jsonData).length > 0) {
                                const firstFile = Object.keys(jsonData)[0];
                                selectFile(firstFile);
                            }
                        }
                    } catch (error) {
                        console.error(`Ëß£ÊûêÂ§±Ë¥•: ${file.name}`, error);
                        loadedCount++;
                        if (loadedCount === fileArray.length) {
                            displayFileList();
                        }
                    }
                };
                reader.readAsText(file);
            });
        }

        function displayFileList() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';

            Object.keys(jsonData).sort().forEach(fileName => {
                const fileInfo = jsonData[fileName];
                const data = fileInfo.data;
                const rubrics = data.rubrics || [];

                const div = document.createElement('div');
                div.className = 'file-item';
                div.onclick = () => selectFile(fileName);

                const sizeKB = (fileInfo.size / 1024).toFixed(1);

                let tagsHTML = '';
                if (currentFormat === 'dr' && data.tags) {
                    tagsHTML = '<div class="file-tags">' +
                        data.tags.map(tag => `<span class="file-tag">${tag}</span>`).join('') +
                        '</div>';
                }

                div.innerHTML = `
                    <div class="file-name">${fileName}</div>
                    <div class="file-meta">${sizeKB} KB ¬∑ ${rubrics.length} ËØÑÂàÜÈ°π</div>
                    ${tagsHTML}
                `;
                fileList.appendChild(div);
            });
        }

        function selectFile(fileName) {
            currentFile = fileName;

            document.querySelectorAll('.file-item').forEach(item => {
                item.classList.remove('active');
                if (item.querySelector('.file-name').textContent === fileName) {
                    item.classList.add('active');
                }
            });

            if (currentFormat === 'kimi') {
                displayDetailKimi(fileName);
            } else {
                displayDetailDR(fileName);
            }
        }

        // Kimi Ê†ºÂºèÊòæÁ§∫
        function displayDetailKimi(fileName) {
            const fileInfo = jsonData[fileName];
            const data = fileInfo.data;
            const rightPanel = document.getElementById('rightPanel');

            let html = '<div class="detail-container">';

            // Â§¥ÈÉ®‰ø°ÊÅØ
            html += `
                <div class="detail-header">
                    <div class="detail-title">${data.uid || fileName}</div>
                    <div class="metadata-tags">
                        ${data.case_id ? `<span class="meta-tag"><strong>Case:</strong> ${data.case_id}</span>` : ''}
                        ${data.type ? `<span class="meta-tag"><strong>Á±ªÂûã:</strong> ${data.type}</span>` : ''}
                        ${data.domain && data.domain.level1 ? `<span class="meta-tag"><strong>È¢ÜÂüü:</strong> ${data.domain.level1}</span>` : ''}
                        ${data.scene && data.scene.level1 ? `<span class="meta-tag"><strong>Âú∫ÊôØ:</strong> ${data.scene.level1}</span>` : ''}
                    </div>
                </div>
            `;

            // ÊèêÁ§∫ËØç
            if (data.prompt) {
                html += `
                    <div class="content-section">
                        <div class="section-title">üìù ÊèêÁ§∫ËØç (Prompt)</div>
                        <div class="markdown-content">${renderMarkdown(data.prompt)}</div>
                    </div>
                `;
            }

            // ÂèÇËÄÉÁ≠îÊ°à
            if (data.example_answer_reference) {
                html += `
                    <div class="content-section">
                        <div class="section-title">‚úÖ ÂèÇËÄÉÁ≠îÊ°à (Reference)</div>
                        <div class="markdown-content">${renderMarkdown(data.example_answer_reference)}</div>
                    </div>
                `;
            }

            // Ê®°ÂûãÂõûÁ≠î
            if (data.model_responses) {
                const models = Object.keys(data.model_responses);
                if (models.length > 0) {
                    currentModelTab = models[0];
                    html += `
                        <div class="content-section">
                            <div class="section-title">ü§ñ Ê®°ÂûãÂõûÁ≠î (Model Responses)</div>
                            <div class="model-tabs">
                                ${models.map(model => `
                                    <div class="model-tab ${model === currentModelTab ? 'active' : ''}" onclick="switchModelTab('${model}')">
                                        ${formatModelName(model)}
                                    </div>
                                `).join('')}
                            </div>
                            ${models.map(model => `
                                <div class="model-response ${model === currentModelTab ? 'active' : ''}" id="model-${model.replace(/[^a-zA-Z0-9]/g, '_')}">
                                    <div class="markdown-content">${renderMarkdown(data.model_responses[model])}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            }

            // ËØÑÂàÜË°®Ê†º
            const rubrics = data.rubrics || [];
            if (rubrics.length > 0) {
                const modelScoreKeys = getModelScoreKeysKimi(rubrics[0]);

                html += `
                    <div class="scoring-section">
                        <div class="section-title">üìä ËØÑÂàÜËØ¶ÊÉÖ (Scoring Details)</div>
                        <div style="overflow-x: auto;">
                            <table class="rubrics-table">
                                <thead>
                                    <tr>
                                        <th style="min-width: 40px;">#</th>
                                        <th style="min-width: 120px;">ËØÑÂàÜÈ°π</th>
                                        <th style="min-width: 80px;">ÊùÉÈáç</th>
                                        ${modelScoreKeys.map(key => `
                                            <th style="min-width: 90px;">${formatModelName(key.replace('auto_score_', ''))}</th>
                                        `).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rubrics.map((rubric, idx) => `
                                        <tr onclick="showRubricDetailKimi(${idx})">
                                            <td>${rubric.rubric_number || idx + 1}</td>
                                            <td>
                                                <div class="rubric-label">${rubric.rubric_tag || 'N/A'}</div>
                                                ${rubric.rubric_tag_level_2 ? `<div class="rubric-category">${rubric.rubric_tag_level_2}</div>` : ''}
                                            </td>
                                            <td>${rubric.rubric_weight || 0}</td>
                                            ${modelScoreKeys.map(key => `
                                                <td class="score-cell">${formatScore(rubric[key])}</td>
                                            `).join('')}
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            rightPanel.innerHTML = html;
        }

        // Deep Research Ê†ºÂºèÊòæÁ§∫
        function displayDetailDR(fileName) {
            const fileInfo = jsonData[fileName];
            const data = fileInfo.data;
            const rightPanel = document.getElementById('rightPanel');

            let html = '<div class="detail-container">';

            // Â§¥ÈÉ®‰ø°ÊÅØ
            const difficultyClass = data.difficulty_level === 'ÁÆÄÂçï' ? 'difficulty-easy' :
                                   data.difficulty_level === '‰∏≠Á≠â' ? 'difficulty-medium' : 'difficulty-hard';

            html += `
                <div class="detail-header">
                    <div class="detail-title">${fileName}</div>
                    <div class="metadata-tags">
                        ${data.difficulty_level ? `<span class="meta-tag ${difficultyClass}"><strong>ÈöæÂ∫¶:</strong> ${data.difficulty_level}</span>` : ''}
                        ${data.is_chinese ? `<span class="meta-tag"><strong>ËØ≠Ë®Ä:</strong> ${data.is_chinese === 'TRUE' ? '‰∏≠Êñá' : 'Ëã±Êñá'}</span>` : ''}
                        ${data.tags ? data.tags.map(tag => `<span class="meta-tag">üè∑Ô∏è ${tag}</span>`).join('') : ''}
                    </div>
                </div>
            `;

            // ÊèêÁ§∫ËØç
            if (data.prompt) {
                html += `
                    <div class="content-section">
                        <div class="section-title">üìù ÈóÆÈ¢ò (Prompt)</div>
                        <div class="markdown-content">${renderMarkdown(data.prompt)}</div>
                    </div>
                `;
            }

            // ÂèÇËÄÉÁ≠îÊ°àÊÄùË∑Ø
            if (data.example_answer_reference_thinking) {
                html += `
                    <div class="content-section">
                        <div class="section-title">üí≠ ÂèÇËÄÉÁ≠îÊ°àÊÄùË∑Ø</div>
                        <div class="markdown-content">${renderMarkdown(data.example_answer_reference_thinking)}</div>
                    </div>
                `;
            }

            // ÂèÇËÄÉÁ≠îÊ°à
            if (data.example_answer_reference) {
                html += `
                    <div class="content-section">
                        <div class="section-title">‚úÖ ÂèÇËÄÉÁ≠îÊ°à</div>
                        <div class="markdown-content">${renderMarkdown(data.example_answer_reference)}</div>
                    </div>
                `;
            }

            // Ê®°ÂûãÂõûÁ≠î
            if (data.model_response) {
                const models = Object.keys(data.model_response);
                if (models.length > 0) {
                    currentModelTab = models[0];
                    html += `
                        <div class="content-section">
                            <div class="section-title">ü§ñ Ê®°ÂûãÂõûÁ≠î</div>
                            <div class="model-tabs">
                                ${models.map(model => {
                                    const modelData = data.model_response[model];
                                    const displayName = modelData.model_name || model.replace('model_response_', 'Ê®°Âûã ');
                                    return `
                                        <div class="model-tab ${model === currentModelTab ? 'active' : ''}" onclick="switchModelTab('${model}')">
                                            ${displayName}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            ${models.map(model => {
                                const modelData = data.model_response[model];
                                const responseText = modelData.response_text || modelData;
                                return `
                                    <div class="model-response ${model === currentModelTab ? 'active' : ''}" id="model-${model}">
                                        <div class="markdown-content">${renderMarkdown(responseText)}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }
            }

            // ËØÑÂàÜË°®Ê†º
            const rubrics = data.rubrics || [];
            if (rubrics.length > 0) {
                const scoreColumns = getAllScoreKeysDR(data);
                console.log('DR Format - Score Columns:', scoreColumns);
                console.log('DR Format - Number of rubrics:', rubrics.length);
                console.log('DR Format - Number of columns:', scoreColumns.length);
                console.log('DR Format - Has rubric_auto_score:', !!data.rubric_auto_score);
                if (scoreColumns.length > 0) {
                    console.log('DR Format - Sample score value:', getScoreValue(rubrics[0], scoreColumns[0], data));
                }

                html += `
                    <div class="scoring-section">
                        <div class="section-title">üìä ËØÑÂàÜËØ¶ÊÉÖ</div>
                        <div style="overflow-x: auto;">
                            <table class="rubrics-table">
                                <thead>
                                    <tr>
                                        <th style="min-width: 40px;">#</th>
                                        <th style="min-width: 300px;">ËØÑÂàÜÈ°π</th>
                                        <th style="min-width: 80px;">ÊùÉÈáç</th>
                                        ${scoreColumns.map(col => `
                                            <th style="min-width: 90px;">${formatColumnName(col)}</th>
                                        `).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rubrics.map((rubric, idx) => `
                                        <tr onclick="showRubricDetailDR(${idx})">
                                            <td>${rubric.rubric_number || idx + 1}</td>
                                            <td>
                                                <div class="rubric-label">${rubric.rubric_detail || 'N/A'}</div>
                                                ${rubric.rubric_tag && rubric.rubric_tag.category ? `<div class="rubric-category">${rubric.rubric_tag.category}</div>` : ''}
                                            </td>
                                            <td>${rubric.rubric_weight || 0}</td>
                                            ${scoreColumns.map(col => `
                                                <td class="score-cell">${formatScore(getScoreValue(rubric, col, data))}</td>
                                            `).join('')}
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            rightPanel.innerHTML = html;
        }

        function getModelScoreKeysKimi(rubric) {
            if (!rubric) return [];
            return Object.keys(rubric)
                .filter(key => key.startsWith('auto_score_'))
                .sort();
        }

        function getResponseKeys(rubric) {
            if (!rubric || !rubric.scores) return [];
            return Object.keys(rubric.scores)
                .filter(key => (key.includes('human_score') || key.includes('auto_score')) && !key.includes('reason'))
                .sort();
        }

        function getAllScoreKeysDR(data) {
            // Êî∂ÈõÜÊâÄÊúâËØÑÂàÜÂàóÔºöÊØè‰∏™ response ‰∏Ä‰∏™ human Âàó + ‰∏Ä‰∏™ auto Âàó
            const columns = [];

            // 1. ‰ªé rubrics[].scores ‰∏≠ÊâæÂá∫ÊúâÂì™‰∫õ response ÁöÑ human ÂàÜÊï∞
            if (data.rubrics && data.rubrics.length > 0) {
                const humanScoreKeys = Object.keys(data.rubrics[0].scores || {})
                    .filter(key => key.includes('human_score') && !key.includes('reason'));

                // ÊèêÂèñ response ÁºñÂè∑
                const responseNums = new Set();
                humanScoreKeys.forEach(key => {
                    const match = key.match(/response_(\d+)_human_score/);
                    if (match) responseNums.add(parseInt(match[1]));
                });

                // ‰∏∫ÊØè‰∏™ response Ê∑ªÂä† human ÂàóÔºåËé∑ÂèñÊ®°ÂûãÂêçÁß∞
                Array.from(responseNums).sort((a, b) => a - b).forEach(num => {
                    let modelName = `Response ${num}`;
                    const mrKey = `model_response_${num}`;
                    if (data.model_response && data.model_response[mrKey] && data.model_response[mrKey].model_name) {
                        modelName = data.model_response[mrKey].model_name;
                    }
                    columns.push({ type: 'human', responseNum: num, key: `response_${num}_human`, modelName: modelName });
                });
            }

            // 2. ‰ªé rubric_auto_score ‰∏≠ÊâæÂá∫ÊúâÂì™‰∫õ response ÁöÑ auto ÂàÜÊï∞
            if (data.rubric_auto_score) {
                const responseNums = new Set();
                Object.keys(data.rubric_auto_score).forEach(key => {
                    // ‰ªé rubric_1_response_1_auto_score ‰∏≠ÊèêÂèñ response ÁºñÂè∑
                    const match = key.match(/rubric_\d+_response_(\d+)_auto_score/);
                    if (match) responseNums.add(parseInt(match[1]));
                });

                // ‰∏∫ÊØè‰∏™ response Ê∑ªÂä† auto ÂàóÔºåËé∑ÂèñÊ®°ÂûãÂêçÁß∞
                Array.from(responseNums).sort((a, b) => a - b).forEach(num => {
                    let modelName = `Response ${num}`;
                    const mrKey = `model_response_${num}`;
                    if (data.model_response && data.model_response[mrKey] && data.model_response[mrKey].model_name) {
                        modelName = data.model_response[mrKey].model_name;
                    }
                    columns.push({ type: 'auto', responseNum: num, key: `response_${num}_auto`, modelName: modelName });
                });
            }

            // 3. Â§áÁî®Ôºö‰ªé model_response[].scores ‰∏≠ÊâæÔºàÂ¶ÇÊûú rubric_auto_score ‰∏çÂ≠òÂú®Ôºâ
            if (!data.rubric_auto_score && data.model_response) {
                const responseNums = new Set();
                Object.values(data.model_response).forEach(mr => {
                    if (mr.scores && Object.keys(mr.scores).length > 0) {
                        Object.keys(mr.scores).forEach(key => {
                            const match = key.match(/rubric_\d+_response_(\d+)_auto_score/);
                            if (match) responseNums.add(parseInt(match[1]));
                        });
                    }
                });

                Array.from(responseNums).sort((a, b) => a - b).forEach(num => {
                    let modelName = `Response ${num}`;
                    const mrKey = `model_response_${num}`;
                    if (data.model_response && data.model_response[mrKey] && data.model_response[mrKey].model_name) {
                        modelName = data.model_response[mrKey].model_name;
                    }
                    columns.push({ type: 'auto', responseNum: num, key: `response_${num}_auto`, modelName: modelName });
                });
            }

            return columns;
        }

        function getScoreValue(rubric, column, data) {
            // column ÊòØ { type: 'human'/'auto', responseNum: 1, key: 'response_1_human' }
            const rubricNum = rubric.rubric_number;
            const responseNum = column.responseNum;

            if (column.type === 'human') {
                // ‰ªé rubric.scores ‰∏≠Ëé∑Âèñ human ÂàÜÊï∞
                const key = `response_${responseNum}_human_score_1`;
                if (rubric.scores && rubric.scores[key] !== undefined) {
                    return rubric.scores[key];
                }
            } else if (column.type === 'auto') {
                const scoreKey = `rubric_${rubricNum}_response_${responseNum}_auto_score`;

                // ‰ºòÂÖà‰ªé data.rubric_auto_score ‰∏≠Ëé∑Âèñ
                if (data.rubric_auto_score && data.rubric_auto_score[scoreKey] !== undefined) {
                    return data.rubric_auto_score[scoreKey];
                }

                // Â§áÁî®Ôºö‰ªé model_response_{responseNum}.scores ‰∏≠Ëé∑Âèñ
                const mrKey = `model_response_${responseNum}`;
                if (data.model_response && data.model_response[mrKey]) {
                    if (data.model_response[mrKey].scores && data.model_response[mrKey].scores[scoreKey] !== undefined) {
                        return data.model_response[mrKey].scores[scoreKey];
                    }
                }
            }

            return null;
        }

        function formatColumnName(column) {
            // column ÊòØ { type: 'human'/'auto', responseNum: 1, key: 'response_1_human', modelName: 'gpt5_high_search' }
            const modelName = column.modelName || `Response ${column.responseNum}`;
            if (column.type === 'human') {
                return `${modelName}<br>(Human)`;
            } else if (column.type === 'auto') {
                return `${modelName}<br>(Auto)`;
            }
            return column.key;
        }

        function calculateTotalScoresDR(rubrics) {
            if (!rubrics || rubrics.length === 0) return {};

            const responseKeys = getResponseKeys(rubrics[0]);
            const totalScores = {};

            responseKeys.forEach(key => {
                let total = 0;
                rubrics.forEach(rubric => {
                    if (rubric.scores && rubric.scores[key] !== undefined && rubric.scores[key] !== null) {
                        const weight = rubric.rubric_weight || 0;
                        const score = rubric.scores[key];
                        total += score * weight;
                    }
                });
                totalScores[formatResponseKey(key)] = total;
            });

            return totalScores;
        }

        function formatModelName(name) {
            const shortNames = {
                'moonshotai_kimi_k2': 'Kimi K2',
                'qwen_qwen3_max': 'Qwen3',
                'z_ai_glm_4.7': 'GLM 4.7',
                'anthropic_claude_sonnet_4.5': 'Claude',
                'anthropic/claude-sonnet-4.5': 'Claude',
                'openai/gpt-5.2': 'GPT 5.2'
            };
            return shortNames[name] || name.split('/').pop();
        }

        function formatScore(score) {
            if (score === undefined || score === null || score === '') {
                return '<span class="score-value score-other">-</span>';
            }
            const className = score === 1 ? 'score-1' : (score === 0 ? 'score-0' : 'score-other');
            return `<span class="score-value ${className}">${score}</span>`;
        }

        function switchModelTab(model) {
            currentModelTab = model;
            document.querySelectorAll('.model-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            document.querySelectorAll('.model-response').forEach(resp => {
                resp.classList.remove('active');
            });
            const targetId = currentFormat === 'kimi' ?
                'model-' + model.replace(/[^a-zA-Z0-9]/g, '_') :
                'model-' + model;
            document.getElementById(targetId).classList.add('active');
        }

        function renderMarkdown(text) {
            if (!text) return '';
            if (typeof marked !== 'undefined') {
                return marked.parse(text);
            }
            return text.replace(/\n/g, '<br>');
        }

        function showRubricDetailKimi(index) {
            const data = jsonData[currentFile].data;
            const rubric = data.rubrics[index];

            let html = `
                <div class="modal-title">${rubric.rubric_tag || 'N/A'}</div>

                ${rubric.rubric_detail ? `
                    <div class="modal-section">
                        <div class="modal-section-title">ËØÑÂàÜËØ¥Êòé</div>
                        <div class="modal-section-content">${rubric.rubric_detail}</div>
                    </div>
                ` : ''}

                <div class="modal-section">
                    <div class="modal-section-title">ÊùÉÈáç</div>
                    <div class="modal-section-content">${rubric.rubric_weight || 0}</div>
                </div>
            `;

            const modelKeys = Object.keys(rubric).filter(k => k.startsWith('auto_score_'));
            modelKeys.forEach(scoreKey => {
                const modelName = scoreKey.replace('auto_score_', '');
                const cotKey = 'auto_judge_cot_' + modelName;

                html += `
                    <div class="modal-section">
                        <div class="modal-section-title">${formatModelName(modelName)} ËØÑÂàÜ</div>
                        <div class="judgement-box">
                            <div><strong>ÂàÜÊï∞:</strong> ${formatScore(rubric[scoreKey])}</div>
                            ${rubric[cotKey] ? `
                                <div style="margin-top: 8px;"><strong>ÂéüÂõ†:</strong></div>
                                <div style="margin-top: 5px;">${rubric[cotKey]}</div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('rubricModal').classList.add('show');
        }

        function showRubricDetailDR(index) {
            const data = jsonData[currentFile].data;
            const rubric = data.rubrics[index];

            let html = `
                <div class="modal-title">ËØÑÂàÜÈ°π #${rubric.rubric_number || index + 1}</div>

                ${rubric.rubric_detail ? `
                    <div class="modal-section">
                        <div class="modal-section-title">ËØÑÂàÜËØ¥Êòé</div>
                        <div class="modal-section-content">${rubric.rubric_detail}</div>
                    </div>
                ` : ''}

                ${rubric.info_source ? `
                    <div class="modal-section">
                        <div class="modal-section-title">‰ø°ÊÅØÊù•Ê∫ê</div>
                        <div class="modal-section-content">
                            <a href="${rubric.info_source}" target="_blank">${rubric.info_source}</a>
                            ${rubric.info_source_detail ? `<br><small>${rubric.info_source_detail}</small>` : ''}
                        </div>
                    </div>
                ` : ''}

                <div class="modal-section">
                    <div class="modal-section-title">ÊùÉÈáç</div>
                    <div class="modal-section-content">${rubric.rubric_weight || 0}</div>
                </div>

                ${rubric.rubric_tag ? `
                    <div class="modal-section">
                        <div class="modal-section-title">Á±ªÂà´</div>
                        <div class="modal-section-content">${rubric.rubric_tag.category || 'N/A'}</div>
                    </div>
                ` : ''}
            `;

            if (rubric.scores) {
                const responseKeys = Object.keys(rubric.scores).filter(k => k.includes('human_score') && !k.includes('reason'));
                responseKeys.forEach(scoreKey => {
                    const modelNum = scoreKey.match(/response_(\d+)/)[1];
                    const reasonKey = scoreKey.replace('_human_score_1', '').replace('response_', 'human_score_reason_');

                    html += `
                        <div class="modal-section">
                            <div class="modal-section-title">Ê®°Âûã ${modelNum} ‰∫∫Â∑•ËØÑÂàÜ</div>
                            <div class="judgement-box">
                                <div><strong>ÂàÜÊï∞:</strong> ${formatScore(rubric.scores[scoreKey])}</div>
                                ${rubric.scores[reasonKey] ? `
                                    <div style="margin-top: 8px;"><strong>ÂéüÂõ†:</strong></div>
                                    <div style="margin-top: 5px;">${rubric.scores[reasonKey]}</div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
            }

            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('rubricModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('rubricModal').classList.remove('show');
        }

        function clearData() {
            jsonData = {};
            currentFile = null;
            document.getElementById('fileList').innerHTML = '';
            document.getElementById('rightPanel').innerHTML = `
                <div class="empty-state">
                    <div style="font-size: 3em; margin-bottom: 15px;">üìã</div>
                    <h3>ËØ∑‰∏ä‰º† JSON Êñá‰ª∂</h3>
                    <p style="margin-top: 8px;">ÊîØÊåÅÊåá‰ª§Ê†ºÂºèÂíå Deep Research Ê†ºÂºè</p>
                    <p style="margin-top: 5px; font-size: 0.9em;">ÂÖàÈÄâÊã©Ê†ºÂºèÔºåÂÜç‰∏ä‰º†ÂØπÂ∫îÁöÑÊï∞ÊçÆÊñá‰ª∂</p>
                </div>
            `;
        }

        document.getElementById('rubricModal').addEventListener('click', (e) => {
            if (e.target.id === 'rubricModal') {
                closeModal();
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
    </script>
</body>
</html>
